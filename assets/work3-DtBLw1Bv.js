var Dt=(n,o,s)=>{if(!o.has(n))throw TypeError("Cannot "+s)};var d=(n,o,s)=>(Dt(n,o,"read from private field"),s?s.call(n):o.get(n)),g=(n,o,s)=>{if(o.has(n))throw TypeError("Cannot add the same private member more than once");o instanceof WeakSet?o.add(n):o.set(n,s)},E=(n,o,s,t)=>(Dt(n,o,"write to private field"),t?t.call(n,s):o.set(n,s),s);var Ht=(n,o,s,t)=>({set _(e){E(n,o,e,s)},get _(){return d(n,o,t)}}),S=(n,o,s)=>(Dt(n,o,"access private method"),s);import"./modulepreload-polyfill-B5Qt9EMX.js";import{w as us}from"./webgl-obj-loader.min-C5sT1AXD.js";import{G as ms}from"./lil-gui.esm-DNkUmkFf.js";import{c as r,f,n as B,s as y,a as T,l as ds,b as st,m as O,d as Ot,e as it,g as _t,t as Kt}from"./vec3-DxJeS3HW.js";import{m as X,c as D,t as F,f as N,a as A,s as fs,d as ps,i as gs,b as xs}from"./vec4-DVpAb33O.js";import{f as Ms}from"./vec2-AJwhbUHB.js";import{f as Jt}from"./mat3-TIoIkjJn.js";class ws{constructor({texture:o,color:s,normal:t,textureCoords:e}){this.viewPosition=null,this.texture=o,this.color=s,this.normal=t,this.textureCoords=e}getColorBilinear(){}}var et,nt,dt,Ct,Tt,bt,Pt,Z,Q,z,G,It,ft,pt,kt,gt,Et,Zt,St,Qt,rt,yt,Bt,Wt,Vt,Yt,xt,At,W,ut;class ys{constructor({width:o,height:s,cameraPosition:t}){g(this,Et);g(this,St);g(this,rt);g(this,Bt);g(this,Vt);g(this,xt);g(this,W);g(this,et,void 0);g(this,nt,void 0);g(this,dt,void 0);g(this,Ct,new Map);g(this,Tt,new Map);g(this,bt,new Map);g(this,Pt,new Map);g(this,Z,[]);g(this,Q,[]);g(this,z,void 0);g(this,G,void 0);g(this,It,0);g(this,ft,void 0);g(this,pt,void 0);g(this,kt,void 0);g(this,gt,void 0);const e=o*s;E(this,z,o),E(this,G,s),d(this,Z).length=e,d(this,Q).length=e,E(this,gt,t)}get framebuffers(){return d(this,Z)}loadPositions(o){const s=S(this,W,ut).call(this);return d(this,Ct).set(s,o),s}loadIndices(o){const s=S(this,W,ut).call(this);return d(this,Tt).set(s,o),s}loadColors(o){const s=S(this,W,ut).call(this);return d(this,bt).set(s,o),s}loadNormals(o){const s=S(this,W,ut).call(this);return d(this,Pt).set(s,o),s}setModel(o){E(this,et,o)}setView(o){E(this,nt,o)}setProjection(o){E(this,dt,o)}setPixel(o,s){const[t,e]=o;if(t>=0&&t<=d(this,z)&&e>=0&&e<=d(this,G)){const a=S(this,xt,At).call(this,t,e);d(this,Z)[a]=s}}setTexture(o){E(this,ft,o)}setVertexShader(o){E(this,kt,o)}setFragmentShader(o){E(this,pt,o)}setDepthBuffer(o,s){const[t,e]=o,a=S(this,xt,At).call(this,t,e);if(d(this,Q)[a]>s)return d(this,Q)[a]=s,!0}clear({colorBuffer:o=!1,depthBuffer:s=!1}){o&&d(this,Z).fill(r()),s&&d(this,Q).fill(1/0)}draw(o){const e=X(D(),d(this,nt),d(this,et)),a=X(D(),d(this,dt),e);for(const i of o){const l=[F(A(),N(...i.v[0],1),e),F(A(),N(...i.v[1],1),e),F(A(),N(...i.v[2],1),e)].map(c=>f(...c)),u=[F(A(),N(...i.v[0],1),a),F(A(),N(...i.v[1],1),a),F(A(),N(...i.v[2],1),a)];for(const c of u)c[3]!==1&&c[3]!==0&&fs(c,c,1/c[3]);const m=ps(D(),gs(D(),X(D(),d(this,nt),d(this,et)))),p=[F(A(),N(...i.normal[0],0),m),F(A(),N(...i.normal[1],0),m),F(A(),N(...i.normal[2],0),m)];for(const c of u)c[0]=(1-c[0])*d(this,z)/2,c[1]=(1-c[1])*d(this,G)/2,c[2]=c[2]*24.95+25.05;for(let c=0;c<3;c++)i.setVertex(c,u[c]);for(let c=0;c<3;c++)i.setNormal(c,f(...p[c]));i.setColors([f(148,121,92),f(148,121,92),f(148,121,92)]),S(this,Et,Zt).call(this,i,l)}}}et=new WeakMap,nt=new WeakMap,dt=new WeakMap,Ct=new WeakMap,Tt=new WeakMap,bt=new WeakMap,Pt=new WeakMap,Z=new WeakMap,Q=new WeakMap,z=new WeakMap,G=new WeakMap,It=new WeakMap,ft=new WeakMap,pt=new WeakMap,kt=new WeakMap,gt=new WeakMap,Et=new WeakSet,Zt=function(o,s){const{v:t,color:e,textureCoords:a,normal:i}=o,h=t[0][0],l=t[1][0],u=t[2][0],m=t[0][1],p=t[1][1],c=t[2][1],P=Math.floor(Math.max(Math.min(h,l,u),0)),w=Math.ceil(Math.min(Math.max(h,l,u),d(this,z))),C=Math.floor(Math.max(Math.min(m,p,c),0)),x=Math.ceil(Math.min(Math.max(m,p,c),d(this,G)));for(let I=P;I<w;I++)for(let M=C;M<x;M++)if(S(this,Vt,Yt).call(this,I+.5,M+.5,t)){const[k,b,V]=S(this,St,Qt).call(this,I+.5,M+.5,t),U=1/(k/t[0][3]+b/t[1][3]+V/t[2][3]);let L=k*t[0][2]/t[0][3]+b*t[1][2]/t[1][3]+V*t[2][2]/t[2][3];L*=U;const K=S(this,rt,yt).call(this,k,b,V,e[0],e[1],e[2]),q=S(this,rt,yt).call(this,k,b,V,i[0],i[1],i[2]),J=S(this,Bt,Wt).call(this,k,b,V,a[0],a[1],a[2]),ht=S(this,rt,yt).call(this,k,b,V,s[0],s[1],s[2]),Mt=[I,M];if(this.setDepthBuffer(Mt,L)){const ot=new ws({color:K,normal:B(q,q),textureCoords:J,texture:d(this,ft)});ot.position=ht,ot.cameraPosition=d(this,gt);const wt=d(this,pt).call(this,ot);this.setPixel(Mt,wt)}}},St=new WeakSet,Qt=function(o,s,t){const e=(o*(t[1][1]-t[2][1])+(t[2][0]-t[1][0])*s+t[1][0]*t[2][1]-t[2][0]*t[1][1])/(t[0][0]*(t[1][1]-t[2][1])+(t[2][0]-t[1][0])*t[0][1]+t[1][0]*t[2][1]-t[2][0]*t[1][1]),a=(o*(t[2][1]-t[0][1])+(t[0][0]-t[2][0])*s+t[2][0]*t[0][1]-t[0][0]*t[2][1])/(t[1][0]*(t[2][1]-t[0][1])+(t[0][0]-t[2][0])*t[1][1]+t[2][0]*t[0][1]-t[0][0]*t[2][1]),i=(o*(t[0][1]-t[1][1])+(t[1][0]-t[0][0])*s+t[0][0]*t[1][1]-t[1][0]*t[0][1])/(t[2][0]*(t[0][1]-t[1][1])+(t[1][0]-t[0][0])*t[2][1]+t[0][0]*t[1][1]-t[1][0]*t[0][1]);return[e,a,i]},rt=new WeakSet,yt=function(o,s,t,e,a,i,h=1){const l=y(r(),e,o),u=y(r(),a,s),m=y(r(),i,t),p=T(r(),T(r(),l,u),m);return y(r(),p,h)},Bt=new WeakSet,Wt=function(o,s,t,e,a,i,h=1){let l=o*e[0]+s*a[0]+t*i[0],u=o*e[1]+s*a[1]+t*i[1];return l/=h,u/=h,Ms(l,u)},Vt=new WeakSet,Yt=function(o,s,t){function e(p,c,P,w,C,x){return(p-C)*(w-x)-(P-C)*(c-x)}const[a,i,h]=t,l=e(o,s,a[0],a[1],i[0],i[1]),u=e(o,s,i[0],i[1],h[0],h[1]),m=e(o,s,h[0],h[1],a[0],a[1]);return l>0&&u>0&&m>0||l<0&&u<0&&m<0},xt=new WeakSet,At=function(o,s){return d(this,z)*Math.floor(d(this,G)-1-s)+Math.floor(o)},W=new WeakSet,ut=function(){return Ht(this,It)._++};class Cs{constructor(){this.v=[],this.color=[],this.textureCoords=[],this.normal=[]}setVertex(o,s){this.v[o]=s}setVertexs(o){this.v=[...o]}setNormal(o,s){this.normal[o]=s}setNormals(o){this.normal=[...o]}setColor(o,s,t,e){if(s<0||s>255||t<0||t>255||e<0||e>255)throw new Error("Invalid color values");this.color[o]=f(s/255,t/255,e/255)}setColors(o){const s=Math.min(3,o.length);for(let t=0;t<s;t++)this.setColor(t,...o[t])}setTextureCoord(o,s){this.textureCoords[o]=s}setTextureCoords(o){this.textureCoords=[...o]}}function Lt(n,o,s){return T(r(),o,y(r(),st(r(),s,o),n))}var Y,v,j;class Ft{constructor(o){g(this,Y,void 0);g(this,v,void 0);g(this,j,void 0);E(this,j,cv.imread(o)),E(this,Y,d(this,j).cols),E(this,v,d(this,j).rows)}get width(){return d(this,Y)}get height(){return d(this,v)}getColor(o,s){const t=o*d(this,Y),e=(1-s)*d(this,v),a=d(this,j).ucharPtr(e,t);return f(...a)}getColorBilinear(o,s){const t=o*d(this,Y),e=(1-s)*d(this,v),a=~~t,i=a+1,h=~~e,l=h+1,u=t-a,m=e-h,p=d(this,j).ucharPtr(h,a),c=d(this,j).ucharPtr(h,i),P=d(this,j).ucharPtr(l,a),w=d(this,j).ucharPtr(l,i),C=Lt(u,p,c),x=Lt(u,P,w);return Lt(m,C,x)}h(o,s){const t=this.getColor(o,s);return ds(t)}}Y=new WeakMap,v=new WeakMap,j=new WeakMap;function tt(n,o,s,t,e,a,i,h,l,u,m,p,c,P,w,C){return xs(n,e,l,c,o,a,u,P,s,i,m,w,t,h,p,C)}function Ts(n){return new Promise((o,s)=>{fetch(n).then(t=>t.text()).then(t=>{const e=new us.OBJ.Mesh(t);o(e)}).catch(t=>{s(t)})})}const Ut=document.querySelector("#canvas-el"),Xt=Ut.getContext("2d"),vt=parseInt(Ut.getAttribute("width")),ts=parseInt(Ut.getAttribute("height")),ss=f(0,0,10),R=new ys({width:vt,height:ts,cameraPosition:ss}),$={TEXTURE:"texture",NORMAL:"normal",PHONG:"phong",BUMP:"bump",DISPLACEMENT:"displacement"};let $t="getColor";function bs(n,o){o=o/180*Math.PI;let[s,t,e]=n;const a=Math.cos(o),i=Math.sin(o),h=1-a,l=Math.sqrt(s*s+t*t+e*e);s/=l,t/=l,e/=l;const u=new tt(h*s*s+a,h*s*t-i*e,h*s*e+i*t,0,h*s*t+i*e,h*t*t+a,h*t*e-i*s,0,h*s*e-i*t,h*t*e+i*s,h*e*e+a,0,0,0,0,1),m=new tt(2.5,0,0,0,0,2.5,0,0,0,0,2.5,0,0,0,0,1),p=new tt(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return X(D(),p,X(D(),u,m))}function Ps(n){let o=D();const s=new tt(1,0,0,-n[0],0,1,0,-n[1],0,0,1,-n[2],0,0,0,1);return X(o,o,s),o}function Is(n,o,s,t){s=-s,t=-t;let e=D();const a=n/180/2*Math.PI,i=s*Math.tan(a),h=i*o,l=-h,u=-i,m=new tt(s,0,0,0,0,s,0,0,0,0,s+t,-s*t,0,0,1,0),p=new tt(2/(h-l),0,0,0,0,2/(i-u),0,0,0,0,2/(t-s),0,0,0,0,1),c=new tt(1,0,0,-(l+h)/2,0,1,0,-(u+i)/2,0,0,1,-(s+t)/2,0,0,0,1),P=X(D(),p,c);return X(e,P,m),e}function ks(n){return n.position}function Es(n){const o=y(r(),T(r(),f(1,1,1),B(r(),n.normal)),.5);return y(o,o,255)}function Ss(n){const{cameraPosition:o,position:s,normal:t,textureCoords:e}=n;let a=r();n.texture&&(a=n.texture[$t](...e));const i=f(.005,.005,.005),h=y(r(),a,1/255),l=f(.7937,.7937,.7937),u={position:f(20,20,20),intensity:f(500,500,500)},m={position:f(-20,20,0),intensity:f(500,500,500)},p=[u,m],c=f(10,10,10),P=150,w=r(),C=O(r(),i,c),x=r(),I=r();for(const M of p){const k=Ot(M.position,s),b=B(r(),st(r(),M.position,s)),V=Math.max(0,it(b,t)),U=y(r(),M.intensity,1/Math.pow(k,2)),L=y(r(),O(r(),h,U),V);T(x,x,L);const K=B(r(),st(r(),o,s)),q=B(r(),T(r(),K,b)),J=Math.pow(Math.max(0,it(q,t)),P),ht=y(r(),O(r(),l,U),J);T(I,I,ht)}return T(w,I,x),T(w,w,C),y(w,w,255)}function Bs(n){const o=f(.005,.005,.005),s=n.color,t=f(.7937,.7937,.7937),e={position:f(20,20,20),intensity:f(500,500,500)},a={position:f(-20,20,0),intensity:f(500,500,500)},i=[e,a],h=f(10,10,10),l=150,{cameraPosition:u,position:m,normal:p}=n;let c=r();const P=O(r(),o,h),w=r(),C=r();for(const x of i){const I=Ot(x.position,m),M=B(r(),st(r(),x.position,m)),k=Math.max(0,it(M,p)),b=y(r(),x.intensity,1/Math.pow(I,2)),V=y(r(),O(r(),s,b),k);T(w,w,V);const U=B(r(),st(r(),u,m)),L=B(r(),T(r(),U,M)),K=Math.pow(Math.max(0,it(L,p)),l),q=y(r(),O(r(),t,b),K);T(C,C,q)}return T(c,C,w),T(c,c,P),y(c,c,255)}function Vs(n){const{normal:o,texture:s,textureCoords:t}=n,e=.2,a=.1,[i,h,l]=o,[u,m]=t,{width:p,height:c}=s,P=f(i*h/Math.sqrt(i*i+l*l),Math.sqrt(i*i+l*l),l*h/Math.sqrt(i*i+l*l)),w=_t(r(),o,P),C=Jt(...P,...w,...o),x=e*a*(s.h(u+1/p,m)-s.h(u,m)),I=e*a*(s.h(u,m+1/c)-s.h(u,m)),M=f(-x,-I,1),b=B(r(),Kt(M,M,C));return y(b,b,255)}function Ns(n){const o=f(.005,.005,.005),s=n.color,t=f(.7937,.7937,.7937),e={position:f(20,20,20),intensity:f(500,500,500)},a={position:f(-20,20,0),intensity:f(500,500,500)},i=[e,a],h=f(10,10,10),{cameraPosition:l,position:u,normal:m,texture:p,textureCoords:c}=n,P=150,w=.2,C=.1,[x,I,M]=m,[k,b]=c,{width:V,height:U}=p,L=f(x*I/Math.sqrt(x*x+M*M),Math.sqrt(x*x+M*M),M*I/Math.sqrt(x*x+M*M)),K=_t(r(),m,L),q=Jt(...L,...K,...m),J=p.h(k,b),ht=w*C*(p.h(k+1/V,b)-J),Mt=w*C*(p.h(k,b+1/U)-J),ot=f(-ht,-Mt,1);T(u,u,y(r(),m,J*C));const wt=B(r(),Kt(ot,ot,q)),lt=r(),es=O(r(),o,h),Nt=r(),Rt=r();for(const jt of i){const ns=Ot(jt.position,u),zt=B(r(),st(r(),jt.position,u)),rs=Math.max(0,it(zt,wt)),Gt=y(r(),jt.intensity,1/Math.pow(ns,2)),is=y(r(),O(r(),s,Gt),rs);T(Nt,Nt,is);const cs=B(r(),st(r(),l,u)),as=B(r(),T(r(),cs,zt)),hs=Math.pow(Math.max(0,it(as,wt)),P),ls=y(r(),O(r(),t,Gt),hs);T(Rt,Rt,ls)}return T(lt,Rt,Nt),T(lt,lt,es),y(lt,lt,255)}let H=140;const os=new ms,_={shaderType:$.TEXTURE,bilinearInterpolation:!1};let qt;Ts("/games101-works-js/models/spot/spot_triangulated_good.obj").then(n=>{qt=n,at.complete&&ct(H,_.shaderType)});const at=document.createElement("img"),mt=document.createElement("img");at.style.display="none";mt.style.display="none";at.src="/games101-works-js/models/spot/spot_texture.svg";mt.src="/games101-works-js/models/spot/hmap.jpg";document.body.append(at);document.body.append(mt);at.onload=function(){qt&&ct(H,_.shaderType)};window.addEventListener("keypress",function(n){n.code==="KeyA"&&(H-=10,ct(H,_.shaderType)),n.code==="KeyD"&&(H+=10,ct(H,_.shaderType))});os.add(_,"shaderType",$).onChange(n=>{ct(H,n)});os.add(_,"bilinearInterpolation").onChange(n=>{n?$t="getColorBilinear":$t="getColor",_.shaderType===$.TEXTURE&&ct(H,_.shaderType)});async function ct(n=0,o=$.NORMAL){const{textures:s,vertices:t,vertexNormals:e,indices:a}=qt,i=[];for(let l=0;l<a.length;l+=3){const u=new Cs,m=a[l],p=a[l+1],c=a[l+2];u.setTextureCoords([f(s[m*2+0],s[m*2+1]),f(s[p*2+0],s[p*2+1]),f(s[c*2+0],s[c*2+1])]),u.setNormals([f(e[m*3+0],e[m*3+1],e[m*3+2]),f(e[p*3+0],e[p*3+1],e[p*3+2]),f(e[c*3+0],e[c*3+1],e[c*3+2])]),u.setVertexs([N(t[m*3+0],t[m*3+1],t[m*3+2],1),N(t[p*3+0],t[p*3+1],t[p*3+2],1),N(t[c*3+0],t[c*3+1],t[c*3+2],1)]),i.push(u)}let h;switch(o){case $.TEXTURE:h=Ss,R.setTexture(new Ft(at));break;case $.NORMAL:h=Es;break;case $.PHONG:h=Bs;break;case $.BUMP:h=Vs,R.setTexture(new Ft(mt));break;case $.DISPLACEMENT:h=Ns,R.setTexture(new Ft(mt));break}R.setVertexShader(ks),R.setFragmentShader(h),R.clear({colorBuffer:!0,depthBuffer:!0}),R.setModel(bs(f(0,1,0),n)),R.setView(Ps(ss)),R.setProjection(Is(45,1,.1,50)),R.draw(i),Rs(R.framebuffers)}function Rs(n){const o=n.length,s=Xt.createImageData(vt,ts);for(var t=0;t<o;t++){var e=t*4;s.data[e]=n[t][0],s.data[e+1]=n[t][1],s.data[e+2]=n[t][2],s.data[e+3]=255}Xt.putImageData(s,0,0)}
