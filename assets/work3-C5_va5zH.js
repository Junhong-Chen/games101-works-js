var Lt=(n,o,s)=>{if(!o.has(n))throw TypeError("Cannot "+s)};var d=(n,o,s)=>(Lt(n,o,"read from private field"),s?s.call(n):o.get(n)),g=(n,o,s)=>{if(o.has(n))throw TypeError("Cannot add the same private member more than once");o instanceof WeakSet?o.add(n):o.set(n,s)},k=(n,o,s,t)=>(Lt(n,o,"write to private field"),t?t.call(n,s):o.set(n,s),s);var Ht=(n,o,s,t)=>({set _(e){k(n,o,e,s)},get _(){return d(n,o,t)}}),S=(n,o,s)=>(Lt(n,o,"access private method"),s);import"./modulepreload-polyfill-B5Qt9EMX.js";import{w as us}from"./webgl-obj-loader.min-C5sT1AXD.js";import{G as ms}from"./lil-gui.esm-DNkUmkFf.js";import{c as r,f,n as B,s as y,a as T,l as ds,b as st,m as U,d as Ut,e as ct,g as _t,t as Kt}from"./vec3-DxJeS3HW.js";import{m as X,c as L,t as A,f as N,a as j,s as fs,d as ps,i as gs,b as xs}from"./vec4-DVpAb33O.js";import{f as Ms}from"./vec2-AJwhbUHB.js";import{f as Jt}from"./mat3-TIoIkjJn.js";class ws{constructor({texture:o,color:s,normal:t,textureCoords:e}){this.viewPosition=null,this.texture=o,this.color=s,this.normal=t,this.textureCoords=e}getColorBilinear(){}}var et,nt,dt,Ct,Tt,bt,Pt,Z,Q,$,G,It,ft,pt,Et,gt,kt,Zt,St,Qt,rt,yt,Bt,Wt,Vt,Yt,xt,jt,W,ut;class ys{constructor({width:o,height:s,cameraPosition:t}){g(this,kt);g(this,St);g(this,rt);g(this,Bt);g(this,Vt);g(this,xt);g(this,W);g(this,et,void 0);g(this,nt,void 0);g(this,dt,void 0);g(this,Ct,new Map);g(this,Tt,new Map);g(this,bt,new Map);g(this,Pt,new Map);g(this,Z,[]);g(this,Q,[]);g(this,$,void 0);g(this,G,void 0);g(this,It,0);g(this,ft,void 0);g(this,pt,void 0);g(this,Et,void 0);g(this,gt,void 0);const e=o*s;k(this,$,o),k(this,G,s),d(this,Z).length=e,d(this,Q).length=e,k(this,gt,t)}get framebuffers(){return d(this,Z)}loadPositions(o){const s=S(this,W,ut).call(this);return d(this,Ct).set(s,o),s}loadIndices(o){const s=S(this,W,ut).call(this);return d(this,Tt).set(s,o),s}loadColors(o){const s=S(this,W,ut).call(this);return d(this,bt).set(s,o),s}loadNormals(o){const s=S(this,W,ut).call(this);return d(this,Pt).set(s,o),s}setModel(o){k(this,et,o)}setView(o){k(this,nt,o)}setProjection(o){k(this,dt,o)}setPixel(o,s){const[t,e]=o;if(t>=0&&t<=d(this,$)&&e>=0&&e<=d(this,G)){const a=S(this,xt,jt).call(this,t,e);d(this,Z)[a]=s}}setTexture(o){k(this,ft,o)}setVertexShader(o){k(this,Et,o)}setFragmentShader(o){k(this,pt,o)}setDepthBuffer(o,s){const[t,e]=o,a=S(this,xt,jt).call(this,t,e);if(d(this,Q)[a]>s)return d(this,Q)[a]=s,!0}clear({colorBuffer:o=!1,depthBuffer:s=!1}){o&&d(this,Z).fill(r()),s&&d(this,Q).fill(1/0)}draw(o){const e=X(L(),d(this,nt),d(this,et)),a=X(L(),d(this,dt),e);for(const c of o){const l=[A(j(),N(...c.v[0],1),e),A(j(),N(...c.v[1],1),e),A(j(),N(...c.v[2],1),e)].map(i=>f(...i)),u=[A(j(),N(...c.v[0],1),a),A(j(),N(...c.v[1],1),a),A(j(),N(...c.v[2],1),a)];for(const i of u)i[3]!==1&&i[3]!==0&&fs(i,i,1/i[3]);const m=ps(L(),gs(L(),X(L(),d(this,nt),d(this,et)))),p=[A(j(),N(...c.normal[0],0),m),A(j(),N(...c.normal[1],0),m),A(j(),N(...c.normal[2],0),m)];for(const i of u)i[0]=(1-i[0])*d(this,$)/2,i[1]=(1-i[1])*d(this,G)/2,i[2]=i[2]*24.95+25.05;for(let i=0;i<3;i++)c.setVertex(i,u[i]);for(let i=0;i<3;i++)c.setNormal(i,f(...p[i]));c.setColors([f(148,121,92),f(148,121,92),f(148,121,92)]),S(this,kt,Zt).call(this,c,l)}}}et=new WeakMap,nt=new WeakMap,dt=new WeakMap,Ct=new WeakMap,Tt=new WeakMap,bt=new WeakMap,Pt=new WeakMap,Z=new WeakMap,Q=new WeakMap,$=new WeakMap,G=new WeakMap,It=new WeakMap,ft=new WeakMap,pt=new WeakMap,Et=new WeakMap,gt=new WeakMap,kt=new WeakSet,Zt=function(o,s){const{v:t,color:e,textureCoords:a,normal:c}=o,h=t[0][0],l=t[1][0],u=t[2][0],m=t[0][1],p=t[1][1],i=t[2][1],P=Math.floor(Math.max(Math.min(h,l,u),0)),w=Math.ceil(Math.min(Math.max(h,l,u),d(this,$))),C=Math.floor(Math.max(Math.min(m,p,i),0)),x=Math.ceil(Math.min(Math.max(m,p,i),d(this,G)));for(let I=P;I<w;I++)for(let M=C;M<x;M++)if(S(this,Vt,Yt).call(this,I+.5,M+.5,t)){const[E,b,V]=S(this,St,Qt).call(this,I+.5,M+.5,t),q=1/(E/t[0][3]+b/t[1][3]+V/t[2][3]);let F=E*t[0][2]/t[0][3]+b*t[1][2]/t[1][3]+V*t[2][2]/t[2][3];F*=q;const K=S(this,rt,yt).call(this,E,b,V,e[0],e[1],e[2]),z=S(this,rt,yt).call(this,E,b,V,c[0],c[1],c[2]),J=S(this,Bt,Wt).call(this,E,b,V,a[0],a[1],a[2]),ht=S(this,rt,yt).call(this,E,b,V,s[0],s[1],s[2]),Mt=[I,M];if(this.setDepthBuffer(Mt,F)){const ot=new ws({color:K,normal:B(z,z),textureCoords:J,texture:d(this,ft)});ot.position=ht,ot.cameraPosition=d(this,gt);const wt=d(this,pt).call(this,ot);this.setPixel(Mt,wt)}}},St=new WeakSet,Qt=function(o,s,t){const e=(o*(t[1][1]-t[2][1])+(t[2][0]-t[1][0])*s+t[1][0]*t[2][1]-t[2][0]*t[1][1])/(t[0][0]*(t[1][1]-t[2][1])+(t[2][0]-t[1][0])*t[0][1]+t[1][0]*t[2][1]-t[2][0]*t[1][1]),a=(o*(t[2][1]-t[0][1])+(t[0][0]-t[2][0])*s+t[2][0]*t[0][1]-t[0][0]*t[2][1])/(t[1][0]*(t[2][1]-t[0][1])+(t[0][0]-t[2][0])*t[1][1]+t[2][0]*t[0][1]-t[0][0]*t[2][1]),c=(o*(t[0][1]-t[1][1])+(t[1][0]-t[0][0])*s+t[0][0]*t[1][1]-t[1][0]*t[0][1])/(t[2][0]*(t[0][1]-t[1][1])+(t[1][0]-t[0][0])*t[2][1]+t[0][0]*t[1][1]-t[1][0]*t[0][1]);return[e,a,c]},rt=new WeakSet,yt=function(o,s,t,e,a,c,h=1){const l=y(r(),e,o),u=y(r(),a,s),m=y(r(),c,t),p=T(r(),T(r(),l,u),m);return y(r(),p,h)},Bt=new WeakSet,Wt=function(o,s,t,e,a,c,h=1){let l=o*e[0]+s*a[0]+t*c[0],u=o*e[1]+s*a[1]+t*c[1];return l/=h,u/=h,Ms(l,u)},Vt=new WeakSet,Yt=function(o,s,t){function e(p,i,P,w,C,x){return(p-C)*(w-x)-(P-C)*(i-x)}const[a,c,h]=t,l=e(o,s,a[0],a[1],c[0],c[1]),u=e(o,s,c[0],c[1],h[0],h[1]),m=e(o,s,h[0],h[1],a[0],a[1]);return l>0&&u>0&&m>0||l<0&&u<0&&m<0},xt=new WeakSet,jt=function(o,s){return d(this,$)*Math.floor(d(this,G)-1-s)+Math.floor(o)},W=new WeakSet,ut=function(){return Ht(this,It)._++};class Cs{constructor(){this.v=[],this.color=[],this.textureCoords=[],this.normal=[]}setVertex(o,s){this.v[o]=s}setVertexs(o){this.v=[...o]}setNormal(o,s){this.normal[o]=s}setNormals(o){this.normal=[...o]}setColor(o,s,t,e){if(s<0||s>255||t<0||t>255||e<0||e>255)throw new Error("Invalid color values");this.color[o]=f(s/255,t/255,e/255)}setColors(o){const s=Math.min(3,o.length);for(let t=0;t<s;t++)this.setColor(t,...o[t])}setTextureCoord(o,s){this.textureCoords[o]=s}setTextureCoords(o){this.textureCoords=[...o]}}function Ft(n,o,s){return T(r(),o,y(r(),st(r(),s,o),n))}var Y,v,D;class At{constructor(o){g(this,Y,void 0);g(this,v,void 0);g(this,D,void 0);k(this,D,cv.imread(o)),k(this,Y,d(this,D).cols),k(this,v,d(this,D).rows)}get width(){return d(this,Y)}get height(){return d(this,v)}getColor(o,s){const t=o*d(this,Y),e=(1-s)*d(this,v),a=d(this,D).ucharPtr(e,t);return f(...a)}getColorBilinear(o,s){const t=o*d(this,Y),e=(1-s)*d(this,v),a=~~t,c=a+1,h=~~e,l=h+1,u=t-a,m=e-h,p=d(this,D).ucharPtr(h,a),i=d(this,D).ucharPtr(h,c),P=d(this,D).ucharPtr(l,a),w=d(this,D).ucharPtr(l,c),C=Ft(u,p,i),x=Ft(u,P,w);return Ft(m,C,x)}h(o,s){const t=this.getColor(o,s);return ds(t)}}Y=new WeakMap,v=new WeakMap,D=new WeakMap;function tt(n,o,s,t,e,a,c,h,l,u,m,p,i,P,w,C){return xs(n,e,l,i,o,a,u,P,s,c,m,w,t,h,p,C)}function Ts(n){return new Promise((o,s)=>{fetch(n).then(t=>t.text()).then(t=>{const e=new us.OBJ.Mesh(t);o(e)}).catch(t=>{s(t)})})}const qt=document.querySelector("#canvas-el"),Xt=qt.getContext("2d"),vt=parseInt(qt.getAttribute("width")),ts=parseInt(qt.getAttribute("height")),ss=f(0,0,10),R=new ys({width:vt,height:ts,cameraPosition:ss}),O={TEXTURE:"texture",NORMAL:"normal",PHONG:"phong",BUMP:"bump",DISPLACEMENT:"displacement"};let Ot="getColor";function bs(n,o){o=o/180*Math.PI;let[s,t,e]=n;const a=Math.cos(o),c=Math.sin(o),h=1-a,l=Math.sqrt(s*s+t*t+e*e);s/=l,t/=l,e/=l;const u=new tt(h*s*s+a,h*s*t-c*e,h*s*e+c*t,0,h*s*t+c*e,h*t*t+a,h*t*e-c*s,0,h*s*e-c*t,h*t*e+c*s,h*e*e+a,0,0,0,0,1),m=new tt(2.5,0,0,0,0,2.5,0,0,0,0,2.5,0,0,0,0,1),p=new tt(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return X(L(),p,X(L(),u,m))}function Ps(n){let o=L();const s=new tt(1,0,0,-n[0],0,1,0,-n[1],0,0,1,-n[2],0,0,0,1);return X(o,o,s),o}function Is(n,o,s,t){s=-s,t=-t;let e=L();const a=n/180/2*Math.PI,c=s*Math.tan(a),h=c*o,l=-h,u=-c,m=new tt(s,0,0,0,0,s,0,0,0,0,s+t,-s*t,0,0,1,0),p=new tt(2/(h-l),0,0,0,0,2/(c-u),0,0,0,0,2/(t-s),0,0,0,0,1),i=new tt(1,0,0,-(l+h)/2,0,1,0,-(u+c)/2,0,0,1,-(s+t)/2,0,0,0,1),P=X(L(),p,i);return X(e,P,m),e}function Es(n){return n.position}function ks(n){const o=y(r(),T(r(),f(1,1,1),B(r(),n.normal)),.5);return y(o,o,255)}function Ss(n){const{cameraPosition:o,position:s,normal:t,textureCoords:e}=n;let a=r();n.texture&&(a=n.texture[Ot](...e));const c=f(.005,.005,.005),h=y(r(),a,1/255),l=f(.7937,.7937,.7937),u={position:f(20,20,20),intensity:f(500,500,500)},m={position:f(-20,20,0),intensity:f(500,500,500)},p=[u,m],i=f(10,10,10),P=150,w=r(),C=U(r(),c,i),x=r(),I=r();for(const M of p){const E=Ut(M.position,s),b=B(r(),st(r(),M.position,s)),V=Math.max(0,ct(b,t)),q=y(r(),M.intensity,1/Math.pow(E,2)),F=y(r(),U(r(),h,q),V);T(x,x,F);const K=B(r(),st(r(),o,s)),z=B(r(),T(r(),K,b)),J=Math.pow(Math.max(0,ct(z,t)),P),ht=y(r(),U(r(),l,q),J);T(I,I,ht)}return T(w,I,x),T(w,w,C),y(w,w,255)}function Bs(n){const o=f(.005,.005,.005),s=n.color,t=f(.7937,.7937,.7937),e={position:f(20,20,20),intensity:f(500,500,500)},a={position:f(-20,20,0),intensity:f(500,500,500)},c=[e,a],h=f(10,10,10),l=150,{cameraPosition:u,position:m,normal:p}=n;let i=r();const P=U(r(),o,h),w=r(),C=r();for(const x of c){const I=Ut(x.position,m),M=B(r(),st(r(),x.position,m)),E=Math.max(0,ct(M,p)),b=y(r(),x.intensity,1/Math.pow(I,2)),V=y(r(),U(r(),s,b),E);T(w,w,V);const q=B(r(),st(r(),u,m)),F=B(r(),T(r(),q,M)),K=Math.pow(Math.max(0,ct(F,p)),l),z=y(r(),U(r(),t,b),K);T(C,C,z)}return T(i,C,w),T(i,i,P),y(i,i,255)}function Vs(n){const{normal:o,texture:s,textureCoords:t}=n,e=.2,a=.1,[c,h,l]=o,[u,m]=t,{width:p,height:i}=s,P=f(c*h/Math.sqrt(c*c+l*l),Math.sqrt(c*c+l*l),l*h/Math.sqrt(c*c+l*l)),w=_t(r(),o,P),C=Jt(...P,...w,...o),x=e*a*(s.h(u+1/p,m)-s.h(u,m)),I=e*a*(s.h(u,m+1/i)-s.h(u,m)),M=f(-x,-I,1),b=B(r(),Kt(M,M,C));return y(b,b,255)}function Ns(n){const o=f(.005,.005,.005),s=n.color,t=f(.7937,.7937,.7937),e={position:f(20,20,20),intensity:f(500,500,500)},a={position:f(-20,20,0),intensity:f(500,500,500)},c=[e,a],h=f(10,10,10),{cameraPosition:l,position:u,normal:m,texture:p,textureCoords:i}=n,P=150,w=.2,C=.1,[x,I,M]=m,[E,b]=i,{width:V,height:q}=p,F=f(x*I/Math.sqrt(x*x+M*M),Math.sqrt(x*x+M*M),M*I/Math.sqrt(x*x+M*M)),K=_t(r(),m,F),z=Jt(...F,...K,...m),J=p.h(E,b),ht=w*C*(p.h(E+1/V,b)-J),Mt=w*C*(p.h(E,b+1/q)-J),ot=f(-ht,-Mt,1);T(u,u,y(r(),m,J*C));const wt=B(r(),Kt(ot,ot,z)),lt=r(),es=U(r(),o,h),Nt=r(),Rt=r();for(const Dt of c){const ns=Ut(Dt.position,u),$t=B(r(),st(r(),Dt.position,u)),rs=Math.max(0,ct($t,wt)),Gt=y(r(),Dt.intensity,1/Math.pow(ns,2)),cs=y(r(),U(r(),s,Gt),rs);T(Nt,Nt,cs);const is=B(r(),st(r(),l,u)),as=B(r(),T(r(),is,$t)),hs=Math.pow(Math.max(0,ct(as,wt)),P),ls=y(r(),U(r(),t,Gt),hs);T(Rt,Rt,ls)}return T(lt,Rt,Nt),T(lt,lt,es),y(lt,lt,255)}let H=140;const os=new ms,_={shaderType:O.TEXTURE,bilinearInterpolation:!1};let zt;Ts("/models/spot/spot_triangulated_good.obj").then(n=>{zt=n,at.complete&&it(H,_.shaderType)});const at=document.createElement("img"),mt=document.createElement("img");at.style.display="none";mt.style.display="none";at.src="/models/spot/spot_texture.svg";mt.src="/models/spot/hmap.jpg";document.body.append(at);document.body.append(mt);at.onload=function(){zt&&it(H,_.shaderType)};window.addEventListener("keypress",function(n){n.code==="KeyA"&&(H-=10,it(H,_.shaderType)),n.code==="KeyD"&&(H+=10,it(H,_.shaderType))});os.add(_,"shaderType",O).onChange(n=>{it(H,n)});os.add(_,"bilinearInterpolation").onChange(n=>{n?Ot="getColorBilinear":Ot="getColor",_.shaderType===O.TEXTURE&&it(H,_.shaderType)});async function it(n=0,o=O.NORMAL){const{textures:s,vertices:t,vertexNormals:e,indices:a}=zt,c=[];for(let l=0;l<a.length;l+=3){const u=new Cs,m=a[l],p=a[l+1],i=a[l+2];u.setTextureCoords([f(s[m*2+0],s[m*2+1]),f(s[p*2+0],s[p*2+1]),f(s[i*2+0],s[i*2+1])]),u.setNormals([f(e[m*3+0],e[m*3+1],e[m*3+2]),f(e[p*3+0],e[p*3+1],e[p*3+2]),f(e[i*3+0],e[i*3+1],e[i*3+2])]),u.setVertexs([N(t[m*3+0],t[m*3+1],t[m*3+2],1),N(t[p*3+0],t[p*3+1],t[p*3+2],1),N(t[i*3+0],t[i*3+1],t[i*3+2],1)]),c.push(u)}let h;switch(o){case O.TEXTURE:h=Ss,R.setTexture(new At(at));break;case O.NORMAL:h=ks;break;case O.PHONG:h=Bs;break;case O.BUMP:h=Vs,R.setTexture(new At(mt));break;case O.DISPLACEMENT:h=Ns,R.setTexture(new At(mt));break}R.setVertexShader(Es),R.setFragmentShader(h),R.clear({colorBuffer:!0,depthBuffer:!0}),R.setModel(bs(f(0,1,0),n)),R.setView(Ps(ss)),R.setProjection(Is(45,1,.1,50)),R.draw(c),Rs(R.framebuffers)}function Rs(n){const o=n.length,s=Xt.createImageData(vt,ts);for(var t=0;t<o;t++){var e=t*4;s.data[e]=n[t][0],s.data[e+1]=n[t][1],s.data[e+2]=n[t][2],s.data[e+3]=255}Xt.putImageData(s,0,0)}
